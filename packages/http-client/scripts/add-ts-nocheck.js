/**
 * @fileoverview Post-generation script to add @ts-nocheck to generated files
 * and ensure TanStack Query exports are included.
 *
 * This script runs after heyAPI generates the client files.
 * It adds `// @ts-nocheck` to the top of generated .ts files to prevent
 * TypeScript errors from the generated code (e.g., duplicate Content-Type headers).
 *
 * Usage: Called automatically by `pnpm generate`
 */
import { readdir, readFile, writeFile, stat } from 'node:fs/promises'
import { join } from 'node:path'
import { fileURLToPath } from 'node:url'

const __dirname = fileURLToPath(new URL('.', import.meta.url))
const clientDir = join(__dirname, '..', 'src', 'client')

async function processDirectory(dir, relativePath = '') {
  const entries = await readdir(dir, { withFileTypes: true })

  for (const entry of entries) {
    const fullPath = join(dir, entry.name)

    if (entry.isDirectory()) {
      await processDirectory(fullPath, join(relativePath, entry.name))
    } else if (entry.name.endsWith('.ts')) {
      const content = await readFile(fullPath, 'utf-8')

      // Skip if already has @ts-nocheck
      if (content.includes('// @ts-nocheck')) {
        continue
      }

      // Add @ts-nocheck after the auto-generated comment
      const newContent = content.replace(
        '// This file is auto-generated by @hey-api/openapi-ts',
        '// This file is auto-generated by @hey-api/openapi-ts\n// @ts-nocheck'
      )

      await writeFile(fullPath, newContent, 'utf-8')
      console.log(`Added @ts-nocheck to ${join(relativePath, entry.name)}`)
    }
  }
}

async function addTanStackQueryExport() {
  const indexPath = join(clientDir, 'index.ts')
  const tanstackDir = join(clientDir, '@tanstack')

  try {
    await stat(tanstackDir)
  } catch {
    console.log('No @tanstack directory found, skipping export addition')
    return
  }

  const content = await readFile(indexPath, 'utf-8')

  // Check if already exported
  if (content.includes('@tanstack/react-query.gen')) {
    console.log('TanStack Query already exported')
    return
  }

  // Add export for TanStack Query
  const newContent = content + "export * from './@tanstack/react-query.gen'\n"
  await writeFile(indexPath, newContent, 'utf-8')
  console.log('Added TanStack Query export to index.ts')
}

async function main() {
  try {
    await processDirectory(clientDir)
    await addTanStackQueryExport()
    console.log('Done!')
  } catch (error) {
    console.error('Error in post-generation script:', error)
    process.exit(1)
  }
}

main()
